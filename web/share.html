<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>æ–‡ä»¶åˆ†äº«ç è§£æå™¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.28/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.28/dist/sweetalert2.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1192.0.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .container {
            background: var(--surface);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }

        .input-group {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
        }

        input[type="text"] {
            padding: 0.8rem 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            font-size: 1rem;
            flex: 1;
            background: rgba(255,255,255,0.9);
        }

        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        button {
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: var(--primary-hover);
        }

        button:active {
            transform: translateY(1px);
        }

        .file-info {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.3);
            margin-top: 1.5rem;
        }

        .file-info h3 {
            color: var(--text);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: rgba(255,255,255,0.95);
            padding: 2rem;
            border-radius: 1.5rem;
            width: 600px;
            max-width: 90%;
            position: relative;
            animation: modalShow 0.3s ease;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        @keyframes modalShow {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* æ–‡ä»¶è¡¨æ ¼ */
        .file-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            --hover-bg: #f8fafc;
            --border-color: #f1f5f9;
        }

        .file-table th {
            background: rgba(241, 245, 249, 0.8);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 1rem;
            border-bottom: 2px solid var(--border-color);
            backdrop-filter: blur(4px);
            position: sticky;
            top: 0;
        }

        .file-table td {
            padding: 1rem;
            color: var(--text);
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .file-table tr:hover td {
            background: var(--hover-bg);
            transform: scale(1.02);
        }

        /* æ–‡ä»¶åˆ—è¡¨å®¹å™¨ */
        .file-list-container {
            flex: 1;
            min-height: 200px;
            max-height: calc(80vh - 180px);
            overflow-y: auto;
            margin: 1rem 0;
            border-radius: 0.75rem;
        }

        /* è·¯å¾„å¯¼èˆª */
        .path-navigation {
            padding: 0.75rem;
            background: rgba(241, 245, 249, 0.5);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .path-navigation a {
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .path-navigation a:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .path-navigation span {
            color: var(--text-secondary);
            margin: 0 0.25rem;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>
<div class="container">
    <h1 style="color: var(--text); margin-bottom: 1.5rem;">ğŸ”— æ–‡ä»¶åˆ†äº«ç è§£æå™¨</h1>

    <div class="input-group">
        <input type="text" id="shareCode" placeholder="è¯·è¾“å…¥åˆ†äº«ç ">
        <button onclick="parseShareCode()">ğŸš€ è§£ææ–‡ä»¶</button>
    </div>

    <div id="fileInfo" class="file-info" style="display: none;">
        <h3 id="fileName"></h3>
        <p style="color: var(--text-secondary);">ğŸ“„ æ–‡ä»¶ç±»å‹: <span id="fileType"></span></p>
        <p style="color: var(--text-secondary);">ğŸ“ æ–‡ä»¶å¤§å°: <span id="fileSize"></span></p>
        <div class="actions">
            <button onclick="downloadFileWrapper()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</button>
            <button onclick="saveToCloud()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">â˜ï¸ ä¿å­˜åˆ°äº‘ç›˜</button>
        </div>
    </div>
</div>

<!-- ä¿å­˜åˆ°äº‘ç›˜æ¨¡æ€æ¡† -->
<div class="modal-mask" id="saveModal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeSaveModal()">&times;</span>
        <h2 class="modal-title">ğŸ“‚ é€‰æ‹©ä¿å­˜ä½ç½®</h2>

        <div id="savePathNav" class="path-navigation"></div>

        <div class="file-list-container">
            <table class="file-table">
                <thead>
                <tr>
                    <th>åç§°</th>
                    <th>ç±»å‹</th>
                </tr>
                </thead>
                <tbody id="saveFileList"></tbody>
            </table>
        </div>

        <div class="modal-actions">
            <button class="cancel-btn" onclick="closeSaveModal()" style="background: #f1f5f9; color: #64748b;">å–æ¶ˆ</button>
            <button class="confirm-btn" onclick="confirmSave()" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white;">ğŸ’¾ ä¿å­˜åˆ°æ­¤å¤„</button>
        </div>
    </div>
</div>
<script>
    let saveCurrentPath = [{ name: 'æ ¹ç›®å½•', id: 0 }];

    function parseShareCode() {
        const shareCode = document.getElementById('shareCode').value.trim();
        const token = localStorage.getItem('token');

        if (!shareCode) {
            Swal.fire('é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†äº«ç ', 'error');
            return;
        }

        const formdata = new FormData();
        formdata.append("Token", token);
        formdata.append("Code", shareCode);

        Swal.fire({
            title: 'è§£æä¸­...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        fetch('/file/getfilebycode', {
            method: 'POST',
            body: formdata,
        })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.base.code !== 200) {
                    Swal.fire('é”™è¯¯', data.base.msg, 'error');
                    return;
                }
                displayFileInfo(data.file);
            })
            .catch(error => {
                Swal.close();
                console.error('Error:', error);
                Swal.fire('é”™è¯¯', 'ç½‘ç»œè¯·æ±‚å¤±è´¥', 'error');
            });
    }

    function displayFileInfo(fileInfo) {
        const infoDiv = document.getElementById('fileInfo');
        infoDiv.style.display = 'block';

        document.getElementById('fileName').textContent = fileInfo.name;
        document.getElementById('fileType').textContent = fileInfo.postfix;
        document.getElementById('fileSize').textContent = formatFileSize(fileInfo.size);

        window.sharedFile = fileInfo;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function downloadFile(fileId, postfix) {
        AWS.config.update({
            accessKeyId: 'vnollxvnollx',
            secretAccessKey: 'vnollxvnollxvnollx',
            region: 'us-east-1',
            endpoint: 'http://106.54.223.38:9000',
            s3ForcePathStyle: true,
            signatureVersion: 'v4'
        });

        const s3 = new AWS.S3();
        const params = {
            Bucket: 'file',
            Key: `FileId=${fileId}.${postfix}`
        };

        try {
            const data = await s3.getObject(params).promise();
            const blob = new Blob([data.Body]);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${window.sharedFile.name}.${postfix}`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error('ä¸‹è½½å¤±è´¥:', error);
            Swal.fire('é”™è¯¯', 'æ–‡ä»¶ä¸‹è½½å¤±è´¥', 'error');
        }
    }

    function downloadFileWrapper() {
        if (window.sharedFile) {
            const fileId = window.sharedFile.file_id;
            const postfix = window.sharedFile.postfix;
            downloadFile(fileId, postfix);
        } else {
            Swal.fire('é”™è¯¯', 'è¯·å…ˆè§£ææ–‡ä»¶ä¿¡æ¯', 'error');
        }
    }

    async function saveToCloud() {
        if (!window.sharedFile) {
            Swal.fire('é”™è¯¯', 'è¯·å…ˆè§£ææ–‡ä»¶ä¿¡æ¯', 'error');
            return;
        }

        await loadSaveFiles(saveCurrentPath[saveCurrentPath.length - 1].id);
        updateSavePathNavigation();
        document.getElementById('saveModal').style.display = 'flex';
    }

    async function loadSaveFiles(parentId) {
        const token = localStorage.getItem('token');
        const fileList = document.getElementById('saveFileList');

        try {
            const formData = new FormData();
            formData.append('ParentFolderId', parentId);
            formData.append('Token', token);

            Swal.fire({
                title: 'åŠ è½½ä¸­...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            const [fileResp, folderResp] = await Promise.all([
                fetch('/file/enquerys', { method: 'POST', body: formData }),
                fetch('/folder/enquerys', { method: 'POST', body: formData })
            ]);

            Swal.close();

            const fileData = await fileResp.json();
            const folderData = await folderResp.json();

            const allItems = [
                ...(fileData.base?.code === 200 ? fileData.files.map(f => ({ ...f, type: 'file' })) : []),
                ...(folderData.base?.code === 200 ? folderData.folders.map(f => ({ ...f, type: 'folder' })) : [])
            ].sort((a, b) => {
                const timeA = new Date(a.upload_time).getTime();
                const timeB = new Date(b.upload_time).getTime();
                return timeB - timeA;
            });

            renderSaveFileList(allItems, fileList);
        } catch (error) {
            Swal.close();
            console.error('è¯·æ±‚å¤±è´¥:', error);
            Swal.fire('é”™è¯¯', 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        }
    }

    function renderSaveFileList(items, fileList) {
        if (!fileList) return;
        fileList.innerHTML = '';

        items.forEach(item => {
            const row = document.createElement('tr');
            if (item.type === 'file') {
                row.innerHTML = `
                    <td>${getFileIcon(item.postfix)} ${item.name}</td>
                    <td>æ–‡ä»¶</td>
                `;
            } else {
                row.className = 'folder-item';
                row.innerHTML = `
                    <td>ğŸ“ ${item.name}</td>
                    <td>æ–‡ä»¶å¤¹</td>
                `;
                row.addEventListener('click', () => {
                    saveCurrentPath.push({ name: item.name, id: item.folder_id });
                    loadSaveFiles(item.folder_id);
                    updateSavePathNavigation();
                });
            }
            fileList.appendChild(row);
        });
    }

    function updateSavePathNavigation() {
        const pathNav = document.getElementById('savePathNav');
        pathNav.innerHTML = '';

        saveCurrentPath.forEach((path, index) => {
            const isLast = index === saveCurrentPath.length - 1;
            const element = document.createElement(isLast ? 'span' : 'a');

            element.textContent = path.name;
            element.className = isLast ? 'current' : '';
            element.style.cursor = isLast ? 'default' : 'pointer';

            if (!isLast) {
                element.onclick = () => {
                    saveCurrentPath = saveCurrentPath.slice(0, index + 1);
                    loadSaveFiles(path.id);
                };
            }

            pathNav.appendChild(element);

            if (index < saveCurrentPath.length - 1) {
                const separator = document.createElement('span');
                separator.textContent = ' â€º ';
                separator.style.margin = '0 5px';
                pathNav.appendChild(separator);
            }
        });
    }

    async function confirmSave() {
        if (!window.sharedFile) {
            Swal.fire('é”™è¯¯', 'è¯·å…ˆè§£ææ–‡ä»¶ä¿¡æ¯', 'error');
            return;
        }

        const token = localStorage.getItem('token');
        const parentFolderId = saveCurrentPath[saveCurrentPath.length - 1].id;

        Swal.fire({
            title: 'ä¿å­˜ä¸­...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const formData = new FormData();
            formData.append('Token', token);
            formData.append('ParentFolderId', parentFolderId);
            formData.append('Name', window.sharedFile.name);  // ä»sharedFileè·å–æ–‡ä»¶å
            formData.append('Postfix', window.sharedFile.postfix);  // ä»sharedFileè·å–åç¼€
            formData.append('Size', window.sharedFile.size);  // ä»sharedFileè·å–æ–‡ä»¶å¤§å°

            const response = await fetch('/file/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            Swal.close();

            if (data.base.code === 200) {
                Swal.fire({
                    icon: 'success',
                    title: 'ä¿å­˜æˆåŠŸ',
                    showConfirmButton: false,
                    timer: 1500
                });
                // ä¸Šä¼ æ–‡ä»¶åˆ°MinIOæ—¶éœ€è¦è·å–æ–‡ä»¶å†…å®¹ï¼Œå½“å‰ä»£ç ç¼ºå°‘æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®
                // éœ€è¦å…ˆé€šè¿‡downloadFileå‡½æ•°çš„æ–¹å¼è·å–æ–‡ä»¶æ•°æ®ï¼Œå†è¿›è¡Œä¸Šä¼ 
                // ç¤ºä¾‹ä¿®æ”¹ï¼š
                const fileContent = await downloadFileToBlob(window.sharedFile.file_id, window.sharedFile.postfix);
                await uploadToMinIO(fileContent, window.sharedFile.postfix, data.file_id);
                closeSaveModal();
            } else {
                Swal.fire('é”™è¯¯', data.base.msg, 'error');
            }
        } catch (error) {
            Swal.close();
            console.error('ä¿å­˜å¤±è´¥:', error);
            Swal.fire('é”™è¯¯', 'ä¿å­˜æ–‡ä»¶æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
        }
    }
    async function downloadFileToBlob(fileId, postfix) {
        AWS.config.update({
            accessKeyId: 'vnollxvnollx',
            secretAccessKey: 'vnollxvnollxvnollx',
            region: 'us-east-1',
            endpoint: 'http://localhost:9000',
            s3ForcePathStyle: true,
            signatureVersion: 'v4'
        });

        const s3 = new AWS.S3();
        const params = {
            Bucket: 'file',
            Key: `FileId=${fileId}.${postfix}`
        };

        try {
            const data = await s3.getObject(params).promise();
            return new Blob([data.Body]);
        } catch (error) {
            console.error('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥:', error);
            throw error;
        }
    }
    async function uploadToMinIO(file,postfix,fileid) {
        AWS.config.update({
            accessKeyId: 'vnollxvnollx',
            secretAccessKey: 'vnollxvnollxvnollx',
            region: 'us-east-1',
            endpoint: 'http://localhost:9000',
            s3ForcePathStyle: true,
            signatureVersion: 'v4'
        });
        const s3 = new AWS.S3();
        // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
        const fileName = "FileId="+fileid+"."+postfix;

        // ä½¿ç”¨ Promise æ–¹å¼ä¸Šä¼ 
        const uploadResult = await new Promise((resolve, reject) => {
            s3.upload({
                Bucket: 'file',
                Key: fileName,
                Body: file,
                ContentType: file.type
            }, (err, data) => {
                if (err) reject(err);
                else resolve(data);
            });
        });
    }
    function closeSaveModal() {
        document.getElementById('saveModal').style.display = 'none';
        saveCurrentPath = [{ name: 'æ ¹ç›®å½•', id: 0 }];
    }

    function getFileIcon(postfix) {
        const icons = {
            pdf: 'ğŸ“„',
            doc: 'ğŸ“„',
            docx: 'ğŸ“„',
            xls: 'ğŸ“Š',
            xlsx: 'ğŸ“Š',
            jpg: 'ğŸ–¼ï¸',
            png: 'ğŸ–¼ï¸',
            mp4: 'ğŸ¥',
            mp3: 'ğŸµ',
            zip: 'ğŸ“¦'
        };
        return icons[postfix.toLowerCase()] || 'ğŸ“„';
    }
</script>
</body>

</html>